z_quatp_vu01:--z_quatp_vu01
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_option01 nvarchar(10)

set @t_bdate = case when '#non'=[7] then '' else [7] end
set @t_edate = case when '#non'=[8] then char(255) else [8] end
set @t_bcustno = case when '#non'=[9] then '' else [9] end
set @t_ecustno = case when '#non'=[10] then char(255) else [10] end
set @t_option01 = case when '#non'=[11] then '' else [11] end
--sel1含明細表--sel2含合約終止
---------------------------------------------------------------------------------
SET QUOTED_IDENTIFIER OFF
declare @cmd nvarchar(max)
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END

IF OBJECT_ID('tempdb..#tmpa')is not null
BEGIN
	set @cmd = 'drop table #tmpa'
	EXECUTE sp_executesql @cmd
END

create table #tmp(
	gno nvarchar(2),
	recno nvarchar(10),
	datea nvarchar(50),
	noa nvarchar(50),
	cno nvarchar(50),
	acomp nvarchar(100),
	custno  nvarchar(50),
	comp nvarchar(100),
	pno nvarchar(50),
	product nvarchar(50),
	spec nvarchar(50),
	price float,
	weight float,
	eweight float,
	emoney float,
	opay float,
	vmoney float,
	enddate nvarchar(50),
	memo nvarchar(MAX),
	addr2 nvarchar(MAX)
)	
CREATE INDEX tmp_index ON #tmp (noa)

insert #tmp
select '0',row_number() over(order by a.custno,a.datea,a.noa),a.datea,a.noa
,a.cno,a.acomp,a.custno,case when isnull(d.nick,'')!='' then d.nick else a.nick end,'','','',isnull(b.price,0),a.weight,a.eweight
--,isnull(b.price,0)*a.eweight
,0
,isnull(c.opay,0),0,a.conn,replace(a.memo,'chr(10)',' '),a.addr2
from view_quat a left join cust d on a.custno=d.noa
outer apply (select top 1 price from view_quats where noa=a.noa order by no3 )b
outer apply (select sum(opay-unopay) opay from umm where payc=a.noa) c
where (isnull(a.enda,0)=0 or CHARINDEX('sel2',@t_option01)>0) 
and (a.custno between @t_bcustno and @t_ecustno ) 
and (a.datea between @t_bdate and @t_edate)

--處理應收比例
declare @noa nvarchar(50)
declare @apvmemo nvarchar(MAX)
declare @qno1 nvarchar(MAX)
declare @qweight1 nvarchar(MAX)
declare @qno2 nvarchar(MAX)
declare @qweight2 nvarchar(MAX)
declare @tweight float
declare @weight float
declare @total float
declare @ttotal float
declare @payed float
declare @tpayed float
declare @tt_bdate nvarchar(10)

--先處理減少cursor的計算量
create table #tmpa(
	noa nvarchar(50),
	apvmemo nvarchar(MAX),
	total float,
	payed float,
	qno1 nvarchar(50),
	qweight1 float,
	qno2 nvarchar(50),
	qweight2 float
)
CREATE INDEX tmpa_index ON #tmpa (noa)

if(LEN(@t_bdate)>0)
	set @tt_bdate=dbo.q_cdn(@t_bdate,-31)

insert #tmpa
select noa,apvmemo,(case when typea='1' then 1 else -1 end)*total,(case when typea='1' then 1 else -1 end)*payed
,left(apvmemo,charindex('@',apvmemo)-1)
,(case when typea='1' then 1 else -1 end)*cast(SUBSTRING(apvmemo,charindex('@',apvmemo)+1,charindex('##',apvmemo)-charindex('@',apvmemo)-1) as float)
,left(SUBSTRING(apvmemo,charindex('##',apvmemo)+2,len(apvmemo)),CHARINDEX('@',SUBSTRING(apvmemo,charindex('##',apvmemo)+2,len(apvmemo)))-1)
,(case when typea='1' then 1 else -1 end)*cast(SUBSTRING(SUBSTRING(apvmemo,charindex('##',apvmemo)+2,len(apvmemo)),charindex('@',SUBSTRING(apvmemo,charindex('##',apvmemo)+2,len(apvmemo)))+1,len(SUBSTRING(apvmemo,charindex('##',apvmemo)+2,len(apvmemo))))as float)
--使用函數會跑較慢
--,dbo.split(dbo.split(apvmemo,'##',0),'@',0)
--,dbo.split(dbo.split(apvmemo,'##',0),'@',1)
--,dbo.split(dbo.split(apvmemo,'##',1),'@',0)
--,dbo.split(dbo.split(apvmemo,'##',1),'@',1) 
from view_vcc where len(apvmemo)>0
and (custno between @t_bcustno and @t_ecustno ) --出貨與合約客戶會一樣
and datea>= @tt_bdate --會先有合約才會出貨 --避免提早出貨多抓取前1個月的出貨

declare cursor_table cursor for
select noa from #tmp
open cursor_table
fetch next from cursor_table
into @noa
while(@@FETCH_STATUS <> -1)
begin
	set @ttotal=0
	set @tpayed=0
	
	declare cursor_table2 cursor for
	select apvmemo,qno1,qweight1,qno2,qweight2,total,payed from #tmpa where qno1=@noa or qno2=@noa
	open cursor_table2
	fetch next from cursor_table2
	into @apvmemo,@qno1,@qweight1,@qno2,@qweight2,@total,@payed
	while(@@FETCH_STATUS <> -1)
	begin
		set @weight=0
		set @tweight=0

		if(len(@qno1)>0 and @qno1=@noa)
		begin
			set @weight=@qweight1
		end
		
		set @tweight=@tweight+@qweight1
		
		if(len(@qno2)>0 and @qno2=@noa)
		begin
			set @weight=@qweight2
		end
		
		set @tweight=@tweight+@qweight2
		
		set @ttotal=@ttotal+case when @tweight=0 then 0 else (@total*@weight/@tweight) end
		set @tpayed=@tpayed+case when @tweight=0 then 0 else (@payed*@weight/@tweight) end
		
		fetch next from cursor_table2
		into @apvmemo,@qno1,@qweight1,@qno2,@qweight2,@total,@payed
	end
	close cursor_table2
	deallocate cursor_table2
	
	update #tmp
	set vmoney=@ttotal,opay=opay+@tpayed,emoney=@ttotal-(opay+@tpayed)
	where noa=@noa
	
	fetch next from cursor_table
	into @noa
end
close cursor_table
deallocate cursor_table

if(CHARINDEX('sel1',@t_option01)>0)
begin
		insert into #tmp (gno,recno,custno,datea,noa,pno,product,spec,price,eweight)
		select '2',row_number() over(partition by a.noa order by a.noa,a.no3),b.custno,b.datea,a.noa,a.productno,isnull(a.product,'')+' '+isnull(a.size,''),a.spec,a.price,a.eweight
		from view_quats a left join view_quat b on a.noa=b.noa
		where (isnull(b.enda,0)=0 or CHARINDEX('sel2',@t_option01)>0) 
		and (b.custno between @t_bcustno and @t_ecustno ) 
		and (b.datea between @t_bdate and @t_edate)
		and exists (select * from #tmp where noa=a.noa)
end

if((select count(*) from #tmp )>0)
begin
	insert into #tmp(gno,custno,noa,datea,weight,eweight,emoney,opay,vmoney)
	select '1',custno,char(255),char(255),sum(weight),sum(eweight)
	,sum(emoney),sum(opay),sum(vmoney) 
	from #tmp where gno = '0' group by custno
		
	insert into #tmp(gno,custno,datea,weight,eweight,price,emoney,opay,vmoney)
	select '3',char(255),char(255),sum(weight),sum(eweight),case when sum(eweight)=0 then 0 else round(sum(eweight*price)/sum(eweight),2) end
	,sum(emoney),sum(opay),sum(vmoney)
	from #tmp where gno = '0'
	
	insert #tmp (gno,noa,memo,custno,datea) 
	select '4',noa,memo,custno,datea from #tmp where gno = '0' group by noa,memo,custno,datea
end
	
select 
dbo.getComma(weight,[5])+' KG' weight,
dbo.getComma(eweight,[5]) eweight,
dbo.getComma(emoney,0)emoney,
dbo.getComma(opay,0)opay,
dbo.getComma(vmoney,0)vmoney,
'quat_vu?noa=$noa?' qhref, 
* from #tmp
order by custno,datea,noa,case when gno='4' then '01' when gno='1' then '2' when gno='2' then '1' else gno end,recno


IF OBJECT_ID('tempdb..#tmpa')is not null
BEGIN
	set @cmd = 'drop table #tmpa'
	EXECUTE sp_executesql @cmd
END

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END
;
----------------------------------------------------------------------------------------------------------------------------------------------------
z_quatp_vu02:--z_quatp_vu02
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_product nvarchar(90)
declare @t_custtype nvarchar(90)

set @t_bdate = case when '#non'=[7] then '' else [7] end
set @t_edate = case when '#non'=[8] then char(255) else [8] end
set @t_bcustno = case when '#non'=[9] then '' else [9] end
set @t_ecustno = case when '#non'=[10] then char(255) else [10] end
set @t_product = case when '#non'=[12] then '' else [12] end
set @t_custtype = case when '#non'=[13] then '' else [13] end
--------------------------------------------------------------------------------------------------
declare @tmp table( 
	gno  nvarchar(2), 
	recno int,
	custno nvarchar(50), 
	nick nvarchar(50), 
	aweight float, 
	atotal float,
	aprice float, 
	bweight float, 
	btotal float,
	bprice float, 
	weight float, 
	total float,
	price float
) 

insert @tmp
select '0' gno,0 recno,a.custno,'' nick
,sum((case when a.typea='1' then 1 else -1 end)*case when b.ucolor='板料' then b.weight else 0 end) aweight
,sum((case when a.typea='1' then 1 else -1 end)*case when b.ucolor='板料' then b.total else 0 end) atotal
,case when sum((case when a.typea='1' then 1 else -1 end)*case when b.ucolor='板料' then b.weight else 0 end)=0 then 0 
else sum((case when a.typea='1' then 1 else -1 end)*case when b.ucolor='板料' then b.total else 0 end)/sum((case when a.typea='1' then 1 else -1 end)*case when b.ucolor='板料' then b.weight else 0 end) end aprice
,sum((case when a.typea='1' then 1 else -1 end)*case when b.ucolor!='板料' then b.weight else 0 end) bweight
,sum((case when a.typea='1' then 1 else -1 end)*case when b.ucolor!='板料' then b.total else 0 end) btotal
,case when sum((case when a.typea='1' then 1 else -1 end)*case when b.ucolor!='板料' then b.weight else 0 end)=0 then 0 
else sum((case when a.typea='1' then 1 else -1 end)*case when b.ucolor!='板料' then b.total else 0 end)/sum((case when a.typea='1' then 1 else -1 end)*case when b.ucolor!='板料' then b.weight else 0 end) end bprice
,sum((case when a.typea='1' then 1 else -1 end)*b.weight)weight,sum((case when a.typea='1' then 1 else -1 end)*b.total)total
,case when sum((case when a.typea='1' then 1 else -1 end)*b.weight)=0 then 0 else sum((case when a.typea='1' then 1 else -1 end)*b.total)/sum((case when a.typea='1' then 1 else -1 end)*b.weight) end price
from view_vcc a left join view_vccs b on a.noa=b.noa
left join cust c on a.custno=c.noa
where b.product=@t_product
and a.datea between @t_bdate and @t_edate
and a.custno between @t_bcustno and @t_ecustno
and (len(@t_custtype)=0 or c.typea=@t_custtype)
group by a.custno

update a
set nick=isnull((select nick from cust where noa=a.custno),'')
from @tmp a

update a
set recno=nrecno
from (select recno,ROW_NUMBER() over (order by total desc) nrecno from @tmp) a

if((select count(*) from @tmp)>0)
begin
	insert @tmp
	select '1',0,'',''
	,SUM(aweight),SUM(atotal),case when SUM(aweight)=0 then 0 else SUM(atotal)/SUM(aweight) end
	,SUM(bweight),SUM(btotal),case when SUM(bweight)=0 then 0 else SUM(btotal)/SUM(bweight) end
	,SUM(weight),SUM(total),case when SUM(weight)=0 then 0 else SUM(total)/SUM(weight) end
	from @tmp
end

update @tmp
set aprice=ROUND(aprice,2),bprice=ROUND(bprice,2),price=ROUND(price,2)
,atotal=ROUND(atotal,0),btotal=ROUND(btotal,0),total=ROUND(total,0)
,aweight=ROUND(aweight/1000,2),bweight=ROUND(bweight/1000,2),weight=ROUND(weight/1000,2)

select 
dbo.getComma(aweight,2) aweight,
dbo.getComma(atotal,0) atotal,
dbo.getComma(aprice,2) aprice,
dbo.getComma(bweight,2) bweight,
dbo.getComma(btotal,0) btotal,
dbo.getComma(bprice,2) bprice,
dbo.getComma(weight,2) weight,
dbo.getComma(total,0) total,
dbo.getComma(price,2) price,
* from @tmp order by gno,recno
;
------------------------------------------------------------------------------------------------------------------------------------------------
z_quatp_vu03:--z_quatp_vu03
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_product nvarchar(90)

set @t_bdate = case when '#non'=[7] then '' else [7] end
set @t_edate = case when '#non'=[8] then char(255) else [8] end
set @t_product = case when '#non'=[12] then '' else [12] end
--------------------------------------------------------------------------------------------------
--成本計算
SET QUOTED_IDENTIFIER OFF
declare @cmd nvarchar(max)
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END

create table #tmp(
	gno nvarchar(2),
	tablea nvarchar(50),
	datea nvarchar(50),
	noa nvarchar(50),
	noq nvarchar(50),
	product nvarchar(100),
	spec nvarchar(50),
	size nvarchar(50),
	lengthb float,
	class nvarchar(50),
	mount decimal(20,2),
	weight decimal(20,2),
	money float,
	aweight decimal(20,2),
	aprice  decimal(20,2),
	primary key(noa,noq,tablea)
)

insert #tmp (gno,tablea,datea,noa,noq,product,spec,size,lengthb,class,mount,weight,money,aprice)
select '11','ucce',a.datea,a.noa,b.noq,b.product,b.spec,b.size,b.lengthb,b.class,b.mount,b.weight,b.total,0
from view_ucce a left join view_ucces b on a.noa=b.noa 
where a.datea<=@t_edate and b.storeno='7000'
and (len(@t_product)=0 or isnull(b.product,'')=@t_product)
--group by a.datea,a.noa,b.noq,b.product,b.spec,b.size,b.lengthb,b.class,b.storeno

--取起始日之前最後一次盤點並刪除此盤點時間之前的資料
delete a
from #tmp a outer apply (select MAX(datea) datea from #tmp 
where product=a.product and spec=a.spec and size=a.size and lengthb =a.lengthb and class =a.class and datea<=@t_bdate)b
where a.datea<b.datea
	
insert #tmp(gno,tablea,datea,noa,noq,product,spec,size,lengthb,class,mount,weight,money,aprice)
select '12','rc2s',a.datea,a.noa,b.noq,b.product,b.spec,b.size,b.lengthb,b.class,b.mount,b.weight,b.total,0
from view_rc2 a left join view_rc2s b on a.noa=b.noa
outer apply(select datea from #tmp where product=b.product and spec=b.spec and size=b.size and lengthb =b.lengthb and class =b.class and tablea='ucce')c
where a.datea between isnull(c.datea,'') and @t_edate
and b.storeno='7000' and (len(@t_product)=0 or isnull(b.product,'')=@t_product)
	
insert #tmp(gno,tablea,datea,noa,noq,product,spec,size,lengthb,class,mount,weight,money,aprice)
select '13','inas',a.datea,a.noa,b.noq,b.product,b.spec,b.size,b.lengthb,b.class,b.mount,b.weight,b.total,0
from view_ina a left join view_inas b on a.noa=b.noa
outer apply(select datea from #tmp where product=b.product and spec=b.spec and size=b.size and lengthb =b.lengthb and class =b.class and tablea='ucce')c
where a.datea between isnull(c.datea,'') and @t_edate
and a.storeno='7000' and (len(@t_product)=0 or isnull(b.product,'')=@t_product)
	
insert #tmp(gno,tablea,datea,noa,noq,product,spec,size,lengthb,class,mount,weight,money,aprice)
select '14','cubt',a.datea,a.noa,b.noq,b.product,b.spec,b.size,b.lengthb,b.class,b.gmount,b.gweight,0,0
from view_cub a left join view_cubt b on a.noa=b.noa
outer apply(select datea from #tmp where product=b.product and spec=b.spec and size=b.size and lengthb =b.lengthb and class =b.class and tablea='ucce')c
where a.datea between isnull(c.datea,'') and @t_edate
and b.storeno='7000' and (len(@t_product)=0 or isnull(b.product,'')=@t_product)
	
insert #tmp(gno,tablea,datea,noa,noq,product,spec,size,lengthb,class,mount,weight,money,aprice)
select '15','gets',a.datea,a.noa,b.noq,b.product,b.spec,b.size,b.lengthb,b.class,b.mount,b.weight,0,0
from view_get a left join view_gets b on a.noa=b.noa
outer apply(select datea from #tmp where product=b.product and spec=b.spec and size=b.size and lengthb =b.lengthb and class =b.class and tablea='ucce')c
where a.datea between isnull(c.datea,'') and @t_edate
and a.storeno='7000' and (len(@t_product)=0 or isnull(b.product,'')=@t_product)

--計算 成本單價
declare @noa nvarchar(100)
declare @noq nvarchar(100)
declare @tablea nvarchar(100)
declare @storeno nvarchar(100)
declare @x_storeno nvarchar(100)
declare @product nvarchar(100)
declare @x_product nvarchar(100)='~!@#$%^&*'
declare @spec nvarchar(100)
declare @x_spec nvarchar(100)
declare @size nvarchar(100)
declare @x_size nvarchar(100)
declare @lengthb float
declare @x_lengthb float
declare @class nvarchar(100)
declare @x_class nvarchar(100)
declare @mount decimal(18, 4)
declare @weight decimal(18, 4)
declare @money float
declare @t_money float
declare @t_mount decimal(18, 4)
declare @t_weight decimal(18, 4)
declare @avgweight decimal(18, 4)
declare @aprice decimal(18, 4)
declare @stktype float
set @t_mount=0
set @t_weight=0
set @t_money=0
set @avgweight=0
set @aprice=0

declare cursor_table cursor for
select noa,noq,tablea,isnull(product,''),isnull(spec,''),isnull(size,''),isnull(lengthb,''),isnull(class,''),isnull(mount,0),isnull(weight,0),isnull(money,0) from #tmp 
order by isnull(product,''),isnull(size,''),isnull(spec,''),isnull(lengthb,''),isnull(class,''),isnull(datea,''),gno,noa,noq
open cursor_table
fetch next from cursor_table
into @noa,@noq,@tablea,@product,@spec,@size,@lengthb,@class,@mount,@weight,@money
while(@@FETCH_STATUS <> -1)
begin
	--目前出貨以品名,材質,號數
	if(@x_product!='~!@#$%^&*' and (@x_product!=@product or @x_size!=@size or @x_spec!=@spec))--or @x_lengthb!=@lengthb or @x_class!=@class
	begin
		set @t_mount=0
		set @t_weight=0
		set @t_money=0
		set @aprice=0
	end
	
	if(@tablea='ucce')
	begin
		set @t_mount=@mount
		set @t_weight=@weight
		set @t_money=@money
		set @avgweight=case when @t_mount=0 then 0 else round(@t_weight/@t_mount,0) end
		set @aprice=case when @t_weight=0 then 0 else round(@t_money/@t_weight,2) end
		update #tmp set aweight=@avgweight,aprice=@aprice	where noa=@noa and noq=@noq
	end
	else if(@tablea in ('rc2s','inas'))
	begin
		set @t_mount=@t_mount+@mount
		set @t_weight=@t_weight+@weight
		set @t_money=@t_money+@money
		set @avgweight=case when @t_mount=0 then 0 else round(@t_weight/@t_mount,0) end
		set @aprice=case when @t_weight=0 then 0 else round(@t_money/@t_weight,2) end
		update #tmp set aweight=@avgweight,aprice=@aprice where noa=@noa and noq=@noq
	end
	else
	begin
		update #tmp set aweight=@avgweight,aprice=@aprice,money=round((@weight*@aprice),0) where noa=@noa and noq=@noq
		set @t_mount=@t_mount-@mount
		set @t_weight=@t_weight-@weight
		set @t_money=@t_money-round((@weight*@aprice),0)
		set @avgweight=case when @t_mount=0 then 0 else round(@t_weight/@t_mount,0) end
		set @aprice=case when @t_weight=0 then 0 else round(@t_money/@t_weight,2) end
	end
	
	set @x_storeno=@storeno
	set @x_product=@product
	set @x_size=@size
	set @x_spec=@spec
	set @x_lengthb=@lengthb
	set @x_class=@class
	
	fetch next from cursor_table
	into @noa,@noq,@tablea,@product,@spec,@size,@lengthb,@class,@mount,@weight,@money
end
close cursor_table
deallocate cursor_table

---------------------------------------------------------------------------------------------------
declare @tmp table(
	gno nvarchar(1),
	rankno int identity(1,1),
	products nvarchar(MAX),
	mount float,
	weight float,
	total float,
	pertotal float,
	maori float,
	perscnt float,
	costa float
)
insert into @tmp
select '0',b.product
	,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
	,sum((case when a.typea='1' then 1 else -1 end)*b.weight)
	,sum((case when a.typea='1' then 1 else -1 end)*b.total),0
	,sum((case when a.typea='1' then 1 else -1 end)*b.total
	-(case when a.typea='1' then 1 else -1 end)* b.weight *isnull(c.price,0)),0
	,sum((case when a.typea='1' then 1 else -1 end)*b.weight*isnull(c.price,0))
from view_vcc a
left join view_vccs b on a.noa = b.noa
outer apply (select top 1 aprice price from #tmp where datea<=a.datea and product=b.product and spec=b.spec and size=b.size and aprice!=0 order by datea desc,gno desc,noa desc,noq desc) c
where isnull(b.product,'') != '' 
and (a.datea between @t_bdate and @t_edate)
and (len(@t_product)=0 or  b.product=@t_product)
group by b.product
order by sum((case when a.typea='1' then 1 else -1 end)*b.total) desc
,sum((case when a.typea='1' then 1 else -1 end)*b.weight) desc

if((select count(*) from @tmp)>0)
begin
	insert into @tmp
	select '1','',sum(mount),sum(weight),sum(total),0,sum(maori),0,SUM(costa) from @tmp 
end

declare @totTotal float
declare @totMoney float

select @totTotal = (select total from @tmp where gno = '1')
select @totMoney = (select maori from @tmp where gno = '1')

update @tmp set pertotal = case when isnull(@totTotal,0) = 0 then 0 else round((total/@totTotal)*100,2) end
update @tmp set perscnt =case when total=0 then 0 else round(maori/total*100,2) end 
--case when isnull(@totMoney,0) = 0 then 0 else round((maori/@totMoney)*100,2) end

select
	gno,rankno,replace(products,'~#$',char(39)) products,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),4,30)) mount,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),0,30)) weight,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),4,30)) total,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,maori),1)),4,30)) maori,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,costa),1)),4,30)) costa,
	cast(perscnt as nvarchar) + '%' perscnt,
	cast(pertotal as nvarchar) + '%' pertotal
from @tmp order by rankno


IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END
;
------------------------------------------------------------------------------------------------------------------------------------------------
z_quatp_vu04:--z_quatp_vu04
declare @t_custtype nvarchar(90)
declare @t_bsalesno nvarchar(35)
declare @t_esalesno nvarchar(35)
declare @t_lostday nvarchar(90)
declare @t_lostorder nvarchar(10)

set @t_custtype = case when '#non'=[13] then '' else [13] end
set @t_lostday = case when '#non'=[14] then '0' else [14] end
set @t_lostorder = case when '#non'=[15] then '0' else [15] end

declare @now_date nvarchar(10) --今天日期
set @now_date=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @now_date=left(@now_date,3)+'/'+substring(@now_date,4,2)+'/'+right(@now_date,2)

declare @tmp table(
	gno nvarchar(10),
	noa nvarchar(50),
	comp nvarchar(200),
	datea nvarchar(50),
	tel nvarchar(MAX),
	fax nvarchar(MAX),
	mobile nvarchar(MAX),
	addrcomp nvarchar(MAX),
	addrconn nvarchar(MAX)
)
insert @tmp 
select '0',noa,comp,isnull((select MAX(datea) from view_vcc where custno=a.noa),'')
,tel,fax,mobile,addr_comp,addr_home from cust a
where (len(@t_custtype)=0 or isnull(typea,'')=@t_custtype)

delete @tmp where datea>dbo.q_cdn(@now_date,-1*cast(@t_lostday as int))

if @t_lostorder='0'
begin
	select * from @tmp order by datea,noa
end
else 
begin
	select * from @tmp order by noa,datea
end
;

--------------------------------------------------------------------------------------------------