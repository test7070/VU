z_contstp_vu01:--z_contstp_vu01
declare @t_btggno nvarchar(20)
declare @t_etggno nvarchar(20)
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_option01 nvarchar(10)

set @t_btggno = case when '#non'=[3] then '' else [3] end
set @t_etggno = case when '#non'=[4] then char(255) else [4] end
set @t_bdate = case when '#non'=[5] then '' else [5] end
set @t_edate = case when '#non'=[6] then char(255) else [6] end
set @t_option01 = case when '#non'=[7] then '' else [7] end
--sel1含明細表--sel2含合約終止
---------------------------------------------------------------------------------

declare @tmp table(
	gno nvarchar(2),
	recno nvarchar(10),
	datea nvarchar(50),
	noa nvarchar(50),
	cno nvarchar(50),
	acomp nvarchar(100),
	tggno  nvarchar(50),
	comp nvarchar(100),
	pno nvarchar(50),
	product nvarchar(50),
	spec nvarchar(50),
	price float,
	weight float,
	eweight float,
	emoney float,
	opay float,
	rmoney float,
	enddate nvarchar(50),
	memo nvarchar(MAX)
)	

insert @tmp
select '0',row_number() over(order by a.tggno,a.datea,a.noa),a.datea,a.noa
,a.cno,a.acomp,a.tggno,case when isnull(d.nick,'')!='' then d.nick else a.nick end,'','','',isnull(b.price,0),a.ordeweight,a.eweight,isnull(b.price,0)*a.eweight
,isnull(c.opay,0),0,a.econtdate,a.memo
from cont a left join tgg d on a.tggno=d.noa
outer apply (select top 1 price from conts where noa=a.noa order by noq )b
outer apply (select sum(opay) opay from pay where payc=a.noa) c
where (isnull(a.enda,0)=0 or CHARINDEX('sel2',@t_option01)>0) 
and (a.tggno between @t_btggno and @t_etggno ) 
and (a.datea between @t_bdate and @t_edate)

--處理應收比例
declare @noa nvarchar(50)
declare @qweight nvarchar(MAX)
declare @tweight float
declare @weight float
declare @total float
declare @ttotal float

declare cursor_table cursor for
select noa from @tmp
open cursor_table
fetch next from cursor_table
into @noa
while(@@FETCH_STATUS <> -1)
begin
	set @ttotal=0
	
	declare cursor_table2 cursor for
	select transtart,total from view_rc2 where CHARINDEX(@noa,transtart)>0
	open cursor_table2
	fetch next from cursor_table2
	into @qweight,@total
	while(@@FETCH_STATUS <> -1)
	begin
		set @weight=0
		set @tweight=0
		
		if(len(@qweight)>0)
		begin
			if(dbo.split(dbo.split(@qweight,'##',0),'@',0)=@noa)
			begin
				set @weight=cast(dbo.split(dbo.split(@qweight,'##',0),'@',1) as float)
			end
			
			set @tweight=@tweight+cast(dbo.split(dbo.split(@qweight,'##',0),'@',1) as float)
			
			if(dbo.split(dbo.split(@qweight,'##',1),'@',0)=@noa)
			begin
				set @weight=cast(dbo.split(dbo.split(@qweight,'##',1),'@',1) as float)
			end
			set @tweight=@tweight+cast(dbo.split(dbo.split(@qweight,'##',1),'@',1) as float)
		end
		
		--set @ttotal=@ttotal+(@total*@weight/@tweight)
		set @ttotal = case when @tweight > 0 then @ttotal+(@total*@weight/@tweight) else 0 end
		
		fetch next from cursor_table2
		into @qweight,@total
	end
	close cursor_table2
	deallocate cursor_table2
	
	update @tmp
	set rmoney=@ttotal
	where noa=@noa
	
	fetch next from cursor_table
	into @noa
end
close cursor_table
deallocate cursor_table

if(CHARINDEX('sel1',@t_option01)>0)
begin
		insert into @tmp (gno,recno,tggno,datea,noa,pno,product,spec,price,eweight)
		select '2',row_number() over(partition by a.noa order by a.noa,a.noq),b.tggno,b.datea,a.noa,a.productno,isnull(a.product,'')+' '+isnull(a.size,''),a.spec,a.price,a.eweight
		from conts a left join cont b on a.noa=b.noa
		where (isnull(b.enda,0)=0 or CHARINDEX('sel2',@t_option01)>0) 
		and (b.tggno between @t_btggno and @t_etggno ) 
		and (b.datea between @t_bdate and @t_edate)
		and exists (select * from @tmp where noa=a.noa)
end

if((select count(*) from @tmp )>0)
begin
	insert into @tmp(gno,tggno,noa,datea,weight,eweight)
	select '1',tggno,char(255),char(255),sum(weight),sum(eweight) 
	from @tmp where gno = '0' group by tggno
		
	insert into @tmp(gno,tggno,datea,weight,eweight,price)
	select '3',char(255),char(255),sum(weight),sum(eweight) ,case when sum(eweight)=0 then 0 else round(sum(eweight*price)/sum(eweight),2) end
	from @tmp where gno = '0'
	

	--insert @tmp (gno,noa,memo,custno,datea) 
	--select '4',noa,memo,custno,datea from @tmp where gno = '0' group by noa,memo,custno,datea
	insert @tmp (gno,noa,memo,tggno,datea) 
	select '4',noa,memo,tggno,datea from @tmp where gno = '0' group by noa,memo,tggno,datea

end

select 
dbo.getComma(weight,[10])weight,
dbo.getComma(eweight,[10])eweight,
dbo.getComma(emoney,0)emoney,
dbo.getComma(opay,0)mopay,
dbo.getComma(rmoney,0)rmoney,
* from @tmp
order by tggno,datea,noa,case when gno='4' then '01' when gno='1' then '2' when gno='2' then '1' else gno end,recno

;


